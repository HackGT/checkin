var app=angular.module("checkin",["ui.router"]);app.config(["$httpProvider",function(e,t){e.interceptors.push("ApiAuthenticator")}]),app.factory("ApiAuthenticator",["Session","SERVER_URL",function(e,t){return{request:function(n){0!==n.url.indexOf("api/")&&0!==n.url.indexOf("auth/")||(n.url=t.BASE_URL+n.url,n.headers["Access-Control-Allow-Origin"]=t.BASE_URL);var r=e.getToken();return r&&(n.headers["x-access-token"]=r),n}}}]),app.directive("title",["$rootScope","$timeout",function(e,t){return{link:function(){var n=function(n,r){t(function(){e.title=r.data&&r.data.pageTitle?r.data.pageTitle:"Default title"})};e.$on("$stateChangeSuccess",n)}}}]),angular.module("checkin").config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("login",{url:"/login",templateUrl:"views/login/login.html",controller:"LoginController",data:{requireLogin:!1,pageTitle:"Login"}}).state("app",{abstract:!0,views:{"@":{templateUrl:"views/base.html"},"toolbar@app":{templateUrl:"views/toolbar/toolbar.html",controller:"ToolbarController"}},data:{requireLogin:!0,pageTitle:"Checkin"}}).state("app.checkin",{url:"/checkin",templateUrl:"views/checkin/checkin.html",controller:"CheckinController"}).state("app.groups",{url:"/groups",templateUrl:"views/groups/groups.html",controller:"GroupsController"}),t.otherwise("/checkin")}]).run(["$rootScope","$state","Session",function(e,t,n){e.$on("$stateChangeSuccess",function(){document.body.scrollTop=document.documentElement.scrollTop=0}),e.$on("$stateChangeStart",function(e,r,o){var u=r.data.requireLogin;u&&!n.getToken()&&(e.preventDefault(),t.go("login"))}),n.getToken()||t.go("login")}]),angular.module("checkin").factory("AuthService",["$q","$http","$rootScope","$state","Session",function(e,t,n,r,o){function u(t){var n=t.data;return console.log("auth success",n),o.create(n.token,n.user),e(function(e){e(n.user)})}function s(t,n){return console.log("auth fail",t),r.go("login"),e(function(e,n){n(t)})}var c={},i="auth/";return c.loginWithPassword=function(e,n){return t.post(i+"login",{email:e,password:n}).then(u,s)},c.loginWithToken=function(e){return console.warn("Not actually sure if this works yet!"),t.post(i+"login",{token:e}).then(u,function(){400===status&&o.destroy().then(s)})},c}]),angular.module("checkin").factory("GroupService",["$q","$http","Session",function(e,t,n){var r="api/groups/",o={};return o.getGroups=function(){return t.get(r)},o.createGroup=function(e){return t.post(r,{groupName:e})},o.getVolunteers=function(e){return t.get(r+e+"/volunteers")},o.addVolunteerToGroup=function(e,n){return t.put(r+n+"/volunteers/"+e)},o.removeVolunteerFromGroup=function(e,n){return t.delete(r+n+"/volunteers/"+e)},o.addUsersToGroup=function(e,n){return t.put(r+e+"/users",{users:n})},o.removeUsersFromGroup=function(e,n){return t.delete(r+e+"/users",{users:n})},o}]),angular.module("checkin").service("Session",["$rootScope","$window","$q",function(e,t,n){this.create=function(n,r){t.localStorage.jwt=n,t.localStorage.userId=r._id,t.localStorage.currentUser=JSON.stringify(r),e.currentUser=r},this.destroy=function(){return delete t.localStorage.jwt,delete t.localStorage.userId,delete t.localStorage.currentUser,e.currentUser=null,n(function(e,t){e()})},this.getToken=function(){return t.localStorage.jwt},this.getUserId=function(){return t.localStorage.userId},this.getUser=function(){return JSON.parse(t.localStorage.currentUser)}}]),angular.module("checkin").factory("UserService",["$q","$http","Session",function(e,t,n){var r="api/users",o=r+"/",u={};return u.getUsers=function(e){void 0===e.page&&void 0===e.size||(e.page=e.page||0,e.size=e.size||50);var n=e?r+"?"+$.param({text:e.text,page:e.page,size:e.size,group:e.groupId}):o;return t.get(n)},u.checkin=function(e){return t.post(o+e+"/checkin")},u.checkout=function(e){return t.post(o+e+"/checkout")},u}]),angular.module("checkin").controller("CheckinController",["$scope","UserService",function(e,t){function n(){return e.query?e.query.length>0&&e.query.length<3?s:e.query:null}function r(){e.users={users:[],busy:!1,nextPage:0,totalPages:0,totalUsers:0,getNextPage:function(){this.busy||(this.busy=!0,this.nextPage=this.nextPage+1,t.getUsers({text:n(),page:this.nextPage}).then(o.bind(this)))}}}function o(e){console.log(e.data),this.users=this.users.concat(e.data.users),this.totalUsers=e.data.totalUsers,this.totalPages=e.data.totalPages,this.nextPage=this.nextPage+1,this.busy=!1,u.sticky("refresh")}var u=$(".userSearch > .sticky");u.sticky({context:".userList > table"});var s=null;e.searchUsers=function(){var u=n();console.log("query:",u),u!==s&&(s=u,t.getUsers({page:0,text:u}).then(function(t){u===s&&(r(),o.bind(e.users)(t))}))},e.users={},r(),e.selectedUser=null,e.setSelectedUser=function(t){var n=$(".userDetails");n.modal(),e.selectedUser=t,t?n.modal("show"):n.modal("hide")},e.users.getNextPage(),e.checkin=function(e){console.log("checkin",e)},e.checkout=function(e){console.log("checkout",e)}}]),angular.module("checkin").controller("GroupsController",["$scope","UserService","GroupService",function(e,t,n){function r(t){t=t||e.selectedGroup.searchUsers,e.selectedGroup.searchUsers=t.filter(function(t){return e.selectedGroup.users.findIndex(function(e){return e._id===t._id})===-1})}function o(){return!e.userQuery||e.userQuery.length<3?null:e.userQuery}e.groups=[],e.getGroups=function(){n.getGroups().then(function(t){e.groups=t.data})},e.getGroups(),e.createGroup=function(t){t&&n.createGroup(t).then(function(t){e.groups.push(t.data)})},e.selectedGroup=null,e.selectGroup=function(r){e.selectedNewVolunteer=null,e.selectedGroup=r,n.getVolunteers(r._id).then(function(t){e.selectedGroup.volunteers=t.data.volunteers}),t.getUsers({groupId:r._id}).then(function(t){e.selectedGroup.users=t.data.users})},e.selectedNewVolunteer=null,e.setSelectedNewVolunteer=function(t){e.selectedNewVolunteer=t,t&&e.$apply()},e.addNewVolunteer=function(t,r){n.addVolunteerToGroup(t._id,r._id).then(function(t){e.selectedGroup.volunteers.push(t.data),e.setSelectedNewVolunteer(null)})},e.removeVolunteerFromGroup=function(t,r){n.removeVolunteerFromGroup(t._id,r._id).then(function(t){e.selectedGroup.volunteers.splice(e.selectedGroup.volunteers.findIndex(function(e){return e._id===t.data._id}),1)})},$(".add-volunteer").search({apiSettings:{responseAsync:function(n,r){n.urlData.query;t.getUsers({text:n.urlData.query}).then(function(t){results=t.data.users.filter(function(t){return e.selectedGroup.volunteers.findIndex(function(e){return e._id===t._id})===-1}).map(function(e){return{title:e.profile.name||e.email,description:e.profile.name?e.email:void 0,user:e}}),r({results:results})})}},minCharacters:3,onSelect:function(t){e.setSelectedNewVolunteer(t.user)}});var u=null;e.searchUsers=function(){var e=o();console.log("query:",e),e&&e!==u&&(u=e,t.getUsers({text:e}).then(function(t){e===u&&(console.log(t.data),r(t.data.users))}))},e.addUsersToGroup=function(){var t=e.selectedGroup.searchUsers.filter(function(e){return e.active}).map(function(e){return e._id});n.addUsersToGroup(e.selectedGroup._id,t).then(function(t){e.selectedGroup.users=t.data.users,r()})},e.addAllUsersToGroup=function(){var t=e.selectedGroup.searchUsers.map(function(e){return e._id});n.addUsersToGroup(e.selectedGroup._id,t).then(function(t){e.selectedGroup.users=t.data.users,r()})}}]),angular.module("checkin").controller("LoginController",["$scope","$state","AuthService",function(e,t,n){function r(e){console.log("success",e),t.go("app.checkin")}function o(e){console.log("failure",e)}e.login=function(){n.loginWithPassword(e.email,e.password).then(r,o)}}]),angular.module("checkin").controller("ToolbarController",["$scope","$state","$rootScope","Session",function(e,t,n,r){var o=r.getUser();e.states=[{name:"app.checkin",title:"Checkin"},{name:"app.groups",title:"Groups",adminOnly:!0}].filter(function(e){return!(e.adminOnly&&!o.admin)}),$(".logout").click(function(){r.destroy().then(function(){t.go("login")})})}]),angular.module("checkin").constant("SERVER_URL",{BASE_URL:"https://ce4e7571.ngrok.io/"});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsInJvdXRlcy5qcyIsInNlcnZpY2VzL0F1dGhTZXJ2aWNlLmpzIiwic2VydmljZXMvR3JvdXBTZXJ2aWNlLmpzIiwic2VydmljZXMvU2Vzc2lvbi5qcyIsInNlcnZpY2VzL1VzZXJTZXJ2aWNlLmpzIiwiY2hlY2tpbi9jaGVja2luQ29udHJvbGxlci5qcyIsImdyb3Vwcy9ncm91cHNDb250cm9sbGVyLmpzIiwibG9naW4vbG9naW5Db250cm9sbGVyLmpzIiwidG9vbGJhci90b29sYmFyQ29udHJvbGxlci5qcyIsImNvbmZpZy5qcyJdLCJuYW1lcyI6WyJhcHAiLCJhbmd1bGFyIiwibW9kdWxlIiwiY29uZmlnIiwiJGh0dHBQcm92aWRlciIsIlNFUlZFUl9VUkwiLCJpbnRlcmNlcHRvcnMiLCJwdXNoIiwiZmFjdG9yeSIsIlNlc3Npb24iLCJyZXF1ZXN0IiwidXJsIiwiaW5kZXhPZiIsIkJBU0VfVVJMIiwiaGVhZGVycyIsInRva2VuIiwiZ2V0VG9rZW4iLCJkaXJlY3RpdmUiLCIkcm9vdFNjb3BlIiwiJHRpbWVvdXQiLCJsaW5rIiwibGlzdGVuZXIiLCJldmVudCIsInRvU3RhdGUiLCJ0aXRsZSIsImRhdGEiLCJwYWdlVGl0bGUiLCIkb24iLCIkc3RhdGVQcm92aWRlciIsIiR1cmxSb3V0ZXJQcm92aWRlciIsInN0YXRlIiwidGVtcGxhdGVVcmwiLCJjb250cm9sbGVyIiwicmVxdWlyZUxvZ2luIiwiYWJzdHJhY3QiLCJ2aWV3cyIsIkAiLCJ0b29sYmFyQGFwcCIsIm90aGVyd2lzZSIsInJ1biIsIiRzdGF0ZSIsImRvY3VtZW50IiwiYm9keSIsInNjcm9sbFRvcCIsImRvY3VtZW50RWxlbWVudCIsInRvUGFyYW1zIiwicHJldmVudERlZmF1bHQiLCJnbyIsIiRxIiwiJGh0dHAiLCJsb2dpblN1Y2Nlc3MiLCJyZXNwb25zZSIsImNvbnNvbGUiLCJsb2ciLCJjcmVhdGUiLCJ1c2VyIiwicmVzb2x2ZSIsImxvZ2luRmFpbHVyZSIsImNhbGxiYWNrIiwicmVqZWN0IiwiYXV0aFNlcnZpY2UiLCJiYXNlVXJsIiwibG9naW5XaXRoUGFzc3dvcmQiLCJlbWFpbCIsInBhc3N3b3JkIiwicG9zdCIsInRoZW4iLCJsb2dpbldpdGhUb2tlbiIsIndhcm4iLCJzdGF0dXMiLCJkZXN0cm95IiwiZ3JvdXBzIiwiR3JvdXBTZXJ2aWNlIiwiZ2V0R3JvdXBzIiwiZ2V0IiwiY3JlYXRlR3JvdXAiLCJncm91cE5hbWUiLCJnZXRWb2x1bnRlZXJzIiwiZ3JvdXBJZCIsImFkZFZvbHVudGVlclRvR3JvdXAiLCJ2b2x1bnRlZXJJZCIsInB1dCIsInJlbW92ZVZvbHVudGVlckZyb21Hcm91cCIsImRlbGV0ZSIsImFkZFVzZXJzVG9Hcm91cCIsInVzZXJJZHMiLCJ1c2VycyIsInJlbW92ZVVzZXJzRnJvbUdyb3VwIiwic2VydmljZSIsIiR3aW5kb3ciLCJ0aGlzIiwibG9jYWxTdG9yYWdlIiwiand0IiwidXNlcklkIiwiX2lkIiwiY3VycmVudFVzZXIiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0VXNlcklkIiwiZ2V0VXNlciIsInBhcnNlIiwiYmFzZSIsIlVzZXJTZXJ2aWNlIiwiZ2V0VXNlcnMiLCJvcHRpb25zIiwidW5kZWZpbmVkIiwicGFnZSIsInNpemUiLCIkIiwicGFyYW0iLCJ0ZXh0IiwiZ3JvdXAiLCJjaGVja2luIiwiY2hlY2tvdXQiLCIkc2NvcGUiLCJnZXRRdWVyeSIsInF1ZXJ5IiwibGVuZ3RoIiwiY3VycmVudFF1ZXJ5IiwicmVzZXRVc2VyTGlzdCIsImJ1c3kiLCJuZXh0UGFnZSIsInRvdGFsUGFnZXMiLCJ0b3RhbFVzZXJzIiwiZ2V0TmV4dFBhZ2UiLCJsb2FkRnJvbVJlc3BvbnNlIiwiYmluZCIsImNvbmNhdCIsIiRzZWFyY2giLCJzdGlja3kiLCJjb250ZXh0Iiwic2VhcmNoVXNlcnMiLCJzZWxlY3RlZFVzZXIiLCJzZXRTZWxlY3RlZFVzZXIiLCIkdXNlckRldGFpbHMiLCJtb2RhbCIsInNldFNlYXJjaFVzZXJzIiwic2VhcmNoUmVzdWx0cyIsInNlbGVjdGVkR3JvdXAiLCJmaWx0ZXIiLCJmaW5kSW5kZXgiLCJncm91cFVzZXIiLCJ1c2VyUXVlcnkiLCJzZWxlY3RHcm91cCIsInNlbGVjdGVkTmV3Vm9sdW50ZWVyIiwidm9sdW50ZWVycyIsInNldFNlbGVjdGVkTmV3Vm9sdW50ZWVyIiwiJGFwcGx5IiwiYWRkTmV3Vm9sdW50ZWVyIiwic3BsaWNlIiwiZWxlbSIsInNlYXJjaCIsImFwaVNldHRpbmdzIiwicmVzcG9uc2VBc3luYyIsInNldHRpbmdzIiwidXJsRGF0YSIsInNlcnZlclJlc3BvbnNlIiwicmVzdWx0cyIsInZvbHVudGVlciIsIm1hcCIsInByb2ZpbGUiLCJuYW1lIiwiZGVzY3JpcHRpb24iLCJtaW5DaGFyYWN0ZXJzIiwib25TZWxlY3QiLCJzZWxlY3Rpb24iLCJzZWxlY3RlZFVzZXJzIiwiYWN0aXZlIiwiYWRkQWxsVXNlcnNUb0dyb3VwIiwiQXV0aFNlcnZpY2UiLCJvblN1Y2Nlc3MiLCJvbkZhaWx1cmUiLCJsb2dpbiIsInN0YXRlcyIsImFkbWluT25seSIsImFkbWluIiwiY2xpY2siLCJjb25zdGFudCJdLCJtYXBwaW5ncyI6IkFBQUEsR0FBQUEsS0FBQUMsUUFBQUMsT0FBQSxXQUNBLGFBR0FGLEtBQUFHLFFBQ0EsZ0JBQ0EsU0FBQUMsRUFBQUMsR0FHQUQsRUFBQUUsYUFBQUMsS0FBQSx1QkFJQVAsSUFBQVEsUUFBQSxvQkFDQSxVQUNBLGFBQ0EsU0FBQUMsRUFBQUosR0FDQSxPQUNBSyxRQUFBLFNBQUFQLEdBQ0EsSUFBQUEsRUFBQVEsSUFBQUMsUUFBQSxTQUFBLElBQUFULEVBQUFRLElBQUFDLFFBQUEsV0FDQVQsRUFBQVEsSUFBQU4sRUFBQVEsU0FBQVYsRUFBQVEsSUFDQVIsRUFBQVcsUUFBQSwrQkFBQVQsRUFBQVEsU0FFQSxJQUFBRSxHQUFBTixFQUFBTyxVQUlBLE9BSEFELEtBQ0FaLEVBQUFXLFFBQUEsa0JBQUFDLEdBRUFaLE9BTUFILElBQUFpQixVQUFBLFNBQUEsYUFBQSxXQUNBLFNBQUFDLEVBQUFDLEdBQ0EsT0FDQUMsS0FBQSxXQUVBLEdBQUFDLEdBQUEsU0FBQUMsRUFBQUMsR0FFQUosRUFBQSxXQUNBRCxFQUFBTSxNQUFBRCxFQUFBRSxNQUFBRixFQUFBRSxLQUFBQyxVQUNBSCxFQUFBRSxLQUFBQyxVQUFBLGtCQUlBUixHQUFBUyxJQUFBLHNCQUFBTixRQzlDQXBCLFFBQUFDLE9BQUEsV0FDQUMsUUFDQSxpQkFDQSxxQkFDQSxTQUNBeUIsRUFDQUMsR0FDQUQsRUFDQUUsTUFBQSxTQUNBbkIsSUFBQSxTQUNBb0IsWUFBQSx5QkFDQUMsV0FBQSxrQkFDQVAsTUFDQVEsY0FBQSxFQUNBUCxVQUFBLFdBR0FJLE1BQUEsT0FDQUksVUFBQSxFQUNBQyxPQUNBQyxLQUNBTCxZQUFBLG1CQUVBTSxlQUNBTixZQUFBLDZCQUNBQyxXQUFBLHNCQUdBUCxNQUNBUSxjQUFBLEVBQ0FQLFVBQUEsYUFHQUksTUFBQSxlQUNBbkIsSUFBQSxXQUNBb0IsWUFBQSw2QkFDQUMsV0FBQSxzQkFFQUYsTUFBQSxjQUNBbkIsSUFBQSxVQUNBb0IsWUFBQSwyQkFDQUMsV0FBQSxxQkFHQUgsRUFBQVMsVUFBQSxlQUdBQyxLQUNBLGFBQ0EsU0FDQSxVQUNBLFNBQ0FyQixFQUNBc0IsRUFDQS9CLEdBRUFTLEVBQUFTLElBQUEsc0JBQUEsV0FDQWMsU0FBQUMsS0FBQUMsVUFBQUYsU0FBQUcsZ0JBQUFELFVBQUEsSUFHQXpCLEVBQUFTLElBQUEsb0JBQUEsU0FBQUwsRUFBQUMsRUFBQXNCLEdBQ0EsR0FBQVosR0FBQVYsRUFBQUUsS0FBQVEsWUFFQUEsS0FBQXhCLEVBQUFPLGFBQ0FNLEVBQUF3QixpQkFDQU4sRUFBQU8sR0FBQSxZQUlBdEMsRUFBQU8sWUFDQXdCLEVBQUFPLEdBQUEsWUN0RUE5QyxRQUFBQyxPQUFBLFdBQ0FNLFFBQUEsZUFDQSxLQUNBLFFBQ0EsYUFDQSxTQUNBLFVBQ0EsU0FBQXdDLEVBQUFDLEVBQUEvQixFQUFBc0IsRUFBQS9CLEdBSUEsUUFBQXlDLEdBQUFDLEdBQ0EsR0FBQTFCLEdBQUEwQixFQUFBMUIsSUFHQSxPQUZBMkIsU0FBQUMsSUFBQSxlQUFBNUIsR0FDQWhCLEVBQUE2QyxPQUFBN0IsRUFBQVYsTUFBQVUsRUFBQThCLE1BQ0FQLEVBQUEsU0FBQVEsR0FDQUEsRUFBQS9CLEVBQUE4QixRQUlBLFFBQUFFLEdBQUFoQyxFQUFBaUMsR0FHQSxNQUZBTixTQUFBQyxJQUFBLFlBQUE1QixHQUNBZSxFQUFBTyxHQUFBLFNBQ0FDLEVBQUEsU0FBQVEsRUFBQUcsR0FDQUEsRUFBQWxDLEtBaEJBLEdBQUFtQyxNQUNBQyxFQUFBLE9BMkNBLE9BdkJBRCxHQUFBRSxrQkFBQSxTQUFBQyxFQUFBQyxHQUNBLE1BQUFmLEdBQ0FnQixLQUFBSixFQUFBLFNBQ0FFLE1BQUFBLEVBQ0FDLFNBQUFBLElBRUFFLEtBQUFoQixFQUFBTyxJQUlBRyxFQUFBTyxlQUFBLFNBQUFwRCxHQUVBLE1BREFxQyxTQUFBZ0IsS0FBQSx3Q0FDQW5CLEVBQ0FnQixLQUFBSixFQUFBLFNBQ0E5QyxNQUFBQSxJQUVBbUQsS0FBQWhCLEVBQUEsV0FDQSxNQUFBbUIsUUFDQTVELEVBQUE2RCxVQUFBSixLQUFBVCxNQUtBRyxLQ3BEQTNELFFBQUFDLE9BQUEsV0FDQU0sUUFBQSxnQkFDQSxLQUNBLFFBQ0EsVUFDQSxTQUFBd0MsRUFBQUMsRUFBQXhDLEdBQ0EsR0FBQThELEdBQUEsY0FFQUMsSUE4QkEsT0E1QkFBLEdBQUFDLFVBQUEsV0FDQSxNQUFBeEIsR0FBQXlCLElBQUFILElBR0FDLEVBQUFHLFlBQUEsU0FBQUMsR0FDQSxNQUFBM0IsR0FBQWdCLEtBQUFNLEdBQUFLLFVBQUFBLEtBR0FKLEVBQUFLLGNBQUEsU0FBQUMsR0FDQSxNQUFBN0IsR0FBQXlCLElBQUFILEVBQUFPLEVBQUEsZ0JBR0FOLEVBQUFPLG9CQUFBLFNBQUFDLEVBQUFGLEdBQ0EsTUFBQTdCLEdBQUFnQyxJQUFBVixFQUFBTyxFQUFBLGVBQUFFLElBR0FSLEVBQUFVLHlCQUFBLFNBQUFGLEVBQUFGLEdBQ0EsTUFBQTdCLEdBQUFrQyxPQUFBWixFQUFBTyxFQUFBLGVBQUFFLElBR0FSLEVBQUFZLGdCQUFBLFNBQUFOLEVBQUFPLEdBQ0EsTUFBQXBDLEdBQUFnQyxJQUFBVixFQUFBTyxFQUFBLFVBQUFRLE1BQUFELEtBR0FiLEVBQUFlLHFCQUFBLFNBQUFULEVBQUFPLEdBQ0EsTUFBQXBDLEdBQUFrQyxPQUFBWixFQUFBTyxFQUFBLFVBQUFRLE1BQUFELEtBR0FiLEtDdENBdkUsUUFBQUMsT0FBQSxXQUNBc0YsUUFBQSxXQUNBLGFBQ0EsVUFDQSxLQUNBLFNBQUF0RSxFQUFBdUUsRUFBQXpDLEdBQ0EwQyxLQUFBcEMsT0FBQSxTQUFBdkMsRUFBQXdDLEdBQ0FrQyxFQUFBRSxhQUFBQyxJQUFBN0UsRUFDQTBFLEVBQUFFLGFBQUFFLE9BQUF0QyxFQUFBdUMsSUFDQUwsRUFBQUUsYUFBQUksWUFBQUMsS0FBQUMsVUFBQTFDLEdBQ0FyQyxFQUFBNkUsWUFBQXhDLEdBR0FtQyxLQUFBcEIsUUFBQSxXQUtBLGFBSkFtQixHQUFBRSxhQUFBQyxVQUNBSCxHQUFBRSxhQUFBRSxhQUNBSixHQUFBRSxhQUFBSSxZQUNBN0UsRUFBQTZFLFlBQUEsS0FDQS9DLEVBQUEsU0FBQVEsRUFBQUcsR0FDQUgsT0FJQWtDLEtBQUExRSxTQUFBLFdBQ0EsTUFBQXlFLEdBQUFFLGFBQUFDLEtBR0FGLEtBQUFRLFVBQUEsV0FDQSxNQUFBVCxHQUFBRSxhQUFBRSxRQUdBSCxLQUFBUyxRQUFBLFdBQ0EsTUFBQUgsTUFBQUksTUFBQVgsRUFBQUUsYUFBQUksaUJDaENBOUYsUUFBQUMsT0FBQSxXQUNBTSxRQUFBLGVBQ0EsS0FDQSxRQUNBLFVBQ0EsU0FBQXdDLEVBQUFDLEVBQUF4QyxHQUNBLEdBQUE2RSxHQUFBLFlBQ0FlLEVBQUFmLEVBQUEsSUFFQWdCLElBNEJBLE9BMUJBQSxHQUFBQyxTQUFBLFNBQUFDLEdBQ0FDLFNBQUFELEVBQUFFLE1BQUFELFNBQUFELEVBQUFHLE9BQ0FILEVBQUFFLEtBQUFGLEVBQUFFLE1BQUEsRUFDQUYsRUFBQUcsS0FBQUgsRUFBQUcsTUFBQSxHQUlBLElBQUFoRyxHQUFBNkYsRUFBQWxCLEVBQUEsSUFBQXNCLEVBQUFDLE9BRUFDLEtBQUFOLEVBQUFNLEtBQ0FKLEtBQUFGLEVBQUFFLEtBQ0FDLEtBQUFILEVBQUFHLEtBQ0FJLE1BQUFQLEVBQUExQixVQUNBdUIsQ0FFQSxPQUFBcEQsR0FBQXlCLElBQUEvRCxJQUdBMkYsRUFBQVUsUUFBQSxTQUFBbkIsR0FDQSxNQUFBNUMsR0FBQWdCLEtBQUFvQyxFQUFBUixFQUFBLGFBR0FTLEVBQUFXLFNBQUEsU0FBQXBCLEdBQ0EsTUFBQTVDLEdBQUFnQixLQUFBb0MsRUFBQVIsRUFBQSxjQUdBUyxLQ3JDQXJHLFFBQUFDLE9BQUEsV0FDQThCLFdBQUEscUJBQ0EsU0FDQSxjQUNBLFNBQUFrRixFQUFBWixHQVNBLFFBQUFhLEtBQ0EsTUFBQUQsR0FBQUUsTUFFQUYsRUFBQUUsTUFBQUMsT0FBQSxHQUFBSCxFQUFBRSxNQUFBQyxPQUFBLEVBQ0FDLEVBRUFKLEVBQUFFLE1BSkEsS0EyQkEsUUFBQUcsS0FDQUwsRUFBQTVCLE9BQ0FBLFNBQ0FrQyxNQUFBLEVBQ0FDLFNBQUEsRUFDQUMsV0FBQSxFQUNBQyxXQUFBLEVBQ0FDLFlBQUEsV0FDQWxDLEtBQUE4QixPQUVBOUIsS0FBQThCLE1BQUEsRUFDQTlCLEtBQUErQixTQUFBL0IsS0FBQStCLFNBQUEsRUFFQW5CLEVBQUFDLFVBQ0FPLEtBQUFLLElBQ0FULEtBQUFoQixLQUFBK0IsV0FDQXZELEtBQUEyRCxFQUFBQyxLQUFBcEMsVUFvQkEsUUFBQW1DLEdBQUExRSxHQUNBQyxRQUFBQyxJQUFBRixFQUFBMUIsTUFFQWlFLEtBQUFKLE1BQUFJLEtBQUFKLE1BQUF5QyxPQUFBNUUsRUFBQTFCLEtBQUE2RCxPQUVBSSxLQUFBaUMsV0FBQXhFLEVBQUExQixLQUFBa0csV0FDQWpDLEtBQUFnQyxXQUFBdkUsRUFBQTFCLEtBQUFpRyxXQUNBaEMsS0FBQStCLFNBQUEvQixLQUFBK0IsU0FBQSxFQUNBL0IsS0FBQThCLE1BQUEsRUFFQVEsRUFBQUMsT0FBQSxXQWxGQSxHQUFBRCxHQUFBcEIsRUFBQSx3QkFDQW9CLEdBQUFDLFFBQ0FDLFFBQUEscUJBR0EsSUFBQVosR0FBQSxJQVdBSixHQUFBaUIsWUFBQSxXQUNBLEdBQUFmLEdBQUFELEdBQ0EvRCxTQUFBQyxJQUFBLFNBQUErRCxHQUVBQSxJQUFBRSxJQUNBQSxFQUFBRixFQUdBZCxFQUFBQyxVQUNBRyxLQUFBLEVBQ0FJLEtBQUFNLElBQ0FsRCxLQUFBLFNBQUFmLEdBRUFpRSxJQUFBRSxJQUNBQyxJQUNBTSxFQUFBQyxLQUFBWixFQUFBNUIsT0FBQW5DLFFBSUErRCxFQUFBNUIsU0FxQkFpQyxJQUVBTCxFQUFBa0IsYUFBQSxLQUNBbEIsRUFBQW1CLGdCQUFBLFNBQUE5RSxHQUNBLEdBQUErRSxHQUFBMUIsRUFBQSxlQUNBMEIsR0FBQUMsUUFDQXJCLEVBQUFrQixhQUFBN0UsRUFDQUEsRUFDQStFLEVBQUFDLE1BQUEsUUFFQUQsRUFBQUMsTUFBQSxTQUlBckIsRUFBQTVCLE1BQUFzQyxjQWVBVixFQUFBRixRQUFBLFNBQUFuQixHQUNBekMsUUFBQUMsSUFBQSxVQUFBd0MsSUFPQXFCLEVBQUFELFNBQUEsU0FBQXBCLEdBQ0F6QyxRQUFBQyxJQUFBLFdBQUF3QyxPQ3BHQTVGLFFBQUFDLE9BQUEsV0FDQThCLFdBQUEsb0JBQ0EsU0FDQSxjQUNBLGVBQ0EsU0FBQWtGLEVBQUFaLEVBQUE5QixHQWdIQSxRQUFBZ0UsR0FBQUMsR0FDQUEsRUFBQUEsR0FBQXZCLEVBQUF3QixjQUFBUCxZQUNBakIsRUFBQXdCLGNBQUFQLFlBQUFNLEVBRUFFLE9BQUEsU0FBQXBGLEdBQ0EsTUFBQTJELEdBQUF3QixjQUFBcEQsTUFBQXNELFVBQUEsU0FBQUMsR0FDQSxNQUFBQSxHQUFBL0MsTUFBQXZDLEVBQUF1QyxTQUNBLElBSUEsUUFBQXFCLEtBQ0EsT0FBQUQsRUFBQTRCLFdBQUE1QixFQUFBNEIsVUFBQXpCLE9BQUEsRUFDQSxLQUVBSCxFQUFBNEIsVUE5SEE1QixFQUFBM0MsVUFFQTJDLEVBQUF6QyxVQUFBLFdBQ0FELEVBQUFDLFlBQUFQLEtBQUEsU0FBQWYsR0FDQStELEVBQUEzQyxPQUFBcEIsRUFBQTFCLFFBR0F5RixFQUFBekMsWUFFQXlDLEVBQUF2QyxZQUFBLFNBQUFDLEdBQ0FBLEdBRUFKLEVBQUFHLFlBQUFDLEdBQUFWLEtBQUEsU0FBQWYsR0FDQStELEVBQUEzQyxPQUFBaEUsS0FBQTRDLEVBQUExQixTQUlBeUYsRUFBQXdCLGNBQUEsS0FDQXhCLEVBQUE2QixZQUFBLFNBQUFoQyxHQUNBRyxFQUFBOEIscUJBQUEsS0FDQTlCLEVBQUF3QixjQUFBM0IsRUFDQXZDLEVBQUFLLGNBQUFrQyxFQUFBakIsS0FBQTVCLEtBQUEsU0FBQWYsR0FDQStELEVBQUF3QixjQUFBTyxXQUFBOUYsRUFBQTFCLEtBQUF3SCxhQUVBM0MsRUFBQUMsVUFBQXpCLFFBQUFpQyxFQUFBakIsTUFBQTVCLEtBQUEsU0FBQWYsR0FDQStELEVBQUF3QixjQUFBcEQsTUFBQW5DLEVBQUExQixLQUFBNkQsU0FJQTRCLEVBQUE4QixxQkFBQSxLQUNBOUIsRUFBQWdDLHdCQUFBLFNBQUEzRixHQUNBMkQsRUFBQThCLHFCQUFBekYsRUFHQUEsR0FDQTJELEVBQUFpQyxVQUlBakMsRUFBQWtDLGdCQUFBLFNBQUE3RixFQUFBd0QsR0FDQXZDLEVBQUFPLG9CQUFBeEIsRUFBQXVDLElBQUFpQixFQUFBakIsS0FDQTVCLEtBQUEsU0FBQWYsR0FDQStELEVBQUF3QixjQUFBTyxXQUFBMUksS0FBQTRDLEVBQUExQixNQUNBeUYsRUFBQWdDLHdCQUFBLFNBSUFoQyxFQUFBaEMseUJBQUEsU0FBQTNCLEVBQUF3RCxHQUNBdkMsRUFBQVUseUJBQUEzQixFQUFBdUMsSUFBQWlCLEVBQUFqQixLQUNBNUIsS0FBQSxTQUFBZixHQUNBK0QsRUFBQXdCLGNBQUFPLFdBQUFJLE9BQ0FuQyxFQUFBd0IsY0FBQU8sV0FBQUwsVUFBQSxTQUFBVSxHQUNBLE1BQUFBLEdBQUF4RCxNQUFBM0MsRUFBQTFCLEtBQUFxRSxNQUNBLE1BS0FjLEVBQUEsa0JBQUEyQyxRQUNBQyxhQUNBQyxjQUFBLFNBQUFDLEVBQUFoRyxHQUNBZ0csRUFBQUMsUUFBQXZDLEtBQ0FkLEdBQUFDLFVBQUFPLEtBQUE0QyxFQUFBQyxRQUFBdkMsUUFDQWxELEtBQUEsU0FBQTBGLEdBQ0FDLFFBQUFELEVBQUFuSSxLQUFBNkQsTUFFQXFELE9BQUEsU0FBQXBGLEdBQ0EsTUFBQTJELEdBQUF3QixjQUFBTyxXQUFBTCxVQUFBLFNBQUFrQixHQUNBLE1BQUFBLEdBQUFoRSxNQUFBdkMsRUFBQXVDLFNBQ0EsSUFHQWlFLElBQUEsU0FBQXhHLEdBQ0EsT0FDQS9CLE1BQUErQixFQUFBeUcsUUFBQUMsTUFBQTFHLEVBQUFRLE1BQ0FtRyxZQUFBM0csRUFBQXlHLFFBQUFDLEtBQUExRyxFQUFBUSxNQUFBMEMsT0FDQWxELEtBQUFBLEtBR0FHLEdBQ0FtRyxRQUFBQSxjQUtBTSxjQUFBLEVBQ0FDLFNBQUEsU0FBQUMsR0FDQW5ELEVBQUFnQyx3QkFBQW1CLEVBQUE5RyxRQU1BLElBQUErRCxHQUFBLElBQ0FKLEdBQUFpQixZQUFBLFdBQ0EsR0FBQWYsR0FBQUQsR0FDQS9ELFNBQUFDLElBQUEsU0FBQStELEdBRUFBLEdBQUFBLElBQUFFLElBQ0FBLEVBQUFGLEVBRUFkLEVBQUFDLFVBQ0FPLEtBQUFNLElBQ0FsRCxLQUFBLFNBQUFmLEdBQ0FpRSxJQUFBRSxJQUNBbEUsUUFBQUMsSUFBQUYsRUFBQTFCLE1BRUErRyxFQUFBckYsRUFBQTFCLEtBQUE2RCxZQXNCQTRCLEVBQUE5QixnQkFBQSxXQUNBLEdBQUFrRixHQUFBcEQsRUFBQXdCLGNBQUFQLFlBQUFRLE9BQUEsU0FBQXBGLEdBQ0EsTUFBQUEsR0FBQWdILFNBQ0FSLElBQUEsU0FBQXhHLEdBQ0EsTUFBQUEsR0FBQXVDLEtBR0F0QixHQUFBWSxnQkFBQThCLEVBQUF3QixjQUFBNUMsSUFBQXdFLEdBQ0FwRyxLQUFBLFNBQUFmLEdBQ0ErRCxFQUFBd0IsY0FBQXBELE1BQUFuQyxFQUFBMUIsS0FBQTZELE1BQ0FrRCxPQUlBdEIsRUFBQXNELG1CQUFBLFdBQ0EsR0FBQUYsR0FBQXBELEVBQUF3QixjQUFBUCxZQUFBNEIsSUFBQSxTQUFBeEcsR0FDQSxNQUFBQSxHQUFBdUMsS0FHQXRCLEdBQUFZLGdCQUFBOEIsRUFBQXdCLGNBQUE1QyxJQUFBd0UsR0FDQXBHLEtBQUEsU0FBQWYsR0FDQStELEVBQUF3QixjQUFBcEQsTUFBQW5DLEVBQUExQixLQUFBNkQsTUFDQWtELFVDN0pBdkksUUFBQUMsT0FBQSxXQUNBOEIsV0FBQSxtQkFDQSxTQUNBLFNBQ0EsY0FDQSxTQUFBa0YsRUFBQTFFLEVBQUFpSSxHQUVBLFFBQUFDLEdBQUFqSixHQUNBMkIsUUFBQUMsSUFBQSxVQUFBNUIsR0FDQWUsRUFBQU8sR0FBQSxlQUdBLFFBQUE0SCxHQUFBbEosR0FDQTJCLFFBQUFDLElBQUEsVUFBQTVCLEdBR0F5RixFQUFBMEQsTUFBQSxXQUNBSCxFQUFBM0csa0JBQ0FvRCxFQUFBbkQsTUFBQW1ELEVBQUFsRCxVQUNBRSxLQUFBd0csRUFBQUMsT0NuQkExSyxRQUFBQyxPQUFBLFdBQ0E4QixXQUFBLHFCQUNBLFNBQ0EsU0FDQSxhQUNBLFVBQ0EsU0FBQWtGLEVBQUExRSxFQUFBdEIsRUFBQVQsR0FDQSxHQUFBOEMsR0FBQTlDLEVBQUEwRixTQUVBZSxHQUFBMkQsU0FFQVosS0FBQSxjQUNBekksTUFBQSxZQUdBeUksS0FBQSxhQUNBekksTUFBQSxTQUNBc0osV0FBQSxJQUVBbkMsT0FBQSxTQUFBN0csR0FDQSxRQUFBQSxFQUFBZ0osWUFBQXZILEVBQUF3SCxTQUdBbkUsRUFBQSxXQUFBb0UsTUFBQSxXQUNBdkssRUFBQTZELFVBQUFKLEtBQUEsV0FDQTFCLEVBQUFPLEdBQUEsZ0JDdEJBOUMsUUFBQUMsT0FBQSxXQUFBK0ssU0FBQSxjQUNBcEssU0FBQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdjaGVja2luJywgW1xuICAndWkucm91dGVyJyxcbl0pO1xuXG5hcHAuY29uZmlnKFtcbiAgJyRodHRwUHJvdmlkZXInLFxuICBmdW5jdGlvbigkaHR0cFByb3ZpZGVyLCBTRVJWRVJfVVJMKSB7XG5cbiAgICAvLyBhZGQgcm9vdCB1cmwgdG8gYWxsIGFwaSBhbmQgYXV0aCByZXF1ZXN0c1xuICAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goJ0FwaUF1dGhlbnRpY2F0b3InKTtcbiAgfVxuXSk7XG5cbmFwcC5mYWN0b3J5KCdBcGlBdXRoZW50aWNhdG9yJywgW1xuICAnU2Vzc2lvbicsXG4gICdTRVJWRVJfVVJMJyxcbiAgZnVuY3Rpb24oU2Vzc2lvbiwgU0VSVkVSX1VSTCkge1xuICAgIHJldHVybiB7XG4gICAgICByZXF1ZXN0OiBmdW5jdGlvbihjb25maWcpIHtcbiAgICAgICAgaWYgKGNvbmZpZy51cmwuaW5kZXhPZignYXBpLycpID09PSAwIHx8IGNvbmZpZy51cmwuaW5kZXhPZignYXV0aC8nKSA9PT0gMCkge1xuICAgICAgICAgIGNvbmZpZy51cmwgPSBTRVJWRVJfVVJMLkJBU0VfVVJMICsgY29uZmlnLnVybDtcbiAgICAgICAgICBjb25maWcuaGVhZGVyc1snQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJ10gPSBTRVJWRVJfVVJMLkJBU0VfVVJMO1xuICAgICAgICB9XG4gICAgICAgIHZhciB0b2tlbiA9IFNlc3Npb24uZ2V0VG9rZW4oKTtcbiAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgY29uZmlnLmhlYWRlcnNbJ3gtYWNjZXNzLXRva2VuJ10gPSB0b2tlbjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29uZmlnO1xuICAgICAgfVxuICAgIH07XG4gIH1cbl0pO1xuXG5hcHAuZGlyZWN0aXZlKCd0aXRsZScsIFsnJHJvb3RTY29wZScsICckdGltZW91dCcsXG4gIGZ1bmN0aW9uKCRyb290U2NvcGUsICR0aW1lb3V0KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxpbms6IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50LCB0b1N0YXRlKSB7XG5cbiAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICRyb290U2NvcGUudGl0bGUgPSAodG9TdGF0ZS5kYXRhICYmIHRvU3RhdGUuZGF0YS5wYWdlVGl0bGUpID9cbiAgICAgICAgICAgICAgdG9TdGF0ZS5kYXRhLnBhZ2VUaXRsZSA6ICdEZWZhdWx0IHRpdGxlJztcbiAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGxpc3RlbmVyKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5dKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLmNvbmZpZyhbXG4gICAgJyRzdGF0ZVByb3ZpZGVyJyxcbiAgICAnJHVybFJvdXRlclByb3ZpZGVyJyxcbiAgICBmdW5jdGlvbihcbiAgICAgICRzdGF0ZVByb3ZpZGVyLFxuICAgICAgJHVybFJvdXRlclByb3ZpZGVyKSB7XG4gICAgICAgICRzdGF0ZVByb3ZpZGVyXG4gICAgICAgICAgLnN0YXRlKCdsb2dpbicsIHtcbiAgICAgICAgICAgIHVybDogJy9sb2dpbicsXG4gICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCJ2aWV3cy9sb2dpbi9sb2dpbi5odG1sXCIsXG4gICAgICAgICAgICBjb250cm9sbGVyOiAnTG9naW5Db250cm9sbGVyJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgcmVxdWlyZUxvZ2luOiBmYWxzZSxcbiAgICAgICAgICAgICAgcGFnZVRpdGxlOiAnTG9naW4nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5zdGF0ZSgnYXBwJywge1xuICAgICAgICAgICAgYWJzdHJhY3Q6IHRydWUsXG4gICAgICAgICAgICB2aWV3czoge1xuICAgICAgICAgICAgICAnQCc6IHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogXCJ2aWV3cy9iYXNlLmh0bWxcIixcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgJ3Rvb2xiYXJAYXBwJzoge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiBcInZpZXdzL3Rvb2xiYXIvdG9vbGJhci5odG1sXCIsXG4gICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ1Rvb2xiYXJDb250cm9sbGVyJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIHJlcXVpcmVMb2dpbjogdHJ1ZSxcbiAgICAgICAgICAgICAgcGFnZVRpdGxlOiAnQ2hlY2tpbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLnN0YXRlKCdhcHAuY2hlY2tpbicsIHtcbiAgICAgICAgICAgIHVybDogJy9jaGVja2luJyxcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAndmlld3MvY2hlY2tpbi9jaGVja2luLmh0bWwnLFxuICAgICAgICAgICAgY29udHJvbGxlcjogJ0NoZWNraW5Db250cm9sbGVyJyxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5zdGF0ZSgnYXBwLmdyb3VwcycsIHtcbiAgICAgICAgICAgIHVybDogJy9ncm91cHMnLFxuICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICd2aWV3cy9ncm91cHMvZ3JvdXBzLmh0bWwnLFxuICAgICAgICAgICAgY29udHJvbGxlcjogJ0dyb3Vwc0NvbnRyb2xsZXInLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJy9jaGVja2luJyk7XG4gICAgfVxuICBdKVxuICAucnVuKFtcbiAgICAnJHJvb3RTY29wZScsXG4gICAgJyRzdGF0ZScsXG4gICAgJ1Nlc3Npb24nLFxuICAgIGZ1bmN0aW9uKFxuICAgICAgJHJvb3RTY29wZSxcbiAgICAgICRzdGF0ZSxcbiAgICAgIFNlc3Npb24pe1xuXG4gICAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGZ1bmN0aW9uKCkge1xuICAgICAgICBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgPSAwO1xuICAgICAgfSk7XG5cbiAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdGFydCcsIGZ1bmN0aW9uIChldmVudCwgdG9TdGF0ZSwgdG9QYXJhbXMpIHtcbiAgICAgICAgdmFyIHJlcXVpcmVMb2dpbiA9IHRvU3RhdGUuZGF0YS5yZXF1aXJlTG9naW47XG5cbiAgICAgICAgaWYgKHJlcXVpcmVMb2dpbiAmJiAhU2Vzc2lvbi5nZXRUb2tlbigpKSB7XG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAkc3RhdGUuZ28oJ2xvZ2luJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIVNlc3Npb24uZ2V0VG9rZW4oKSkge1xuICAgICAgICAkc3RhdGUuZ28oJ2xvZ2luJyk7XG4gICAgICB9XG4gICAgfVxuICBdKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLmZhY3RvcnkoJ0F1dGhTZXJ2aWNlJywgW1xuICAgICckcScsXG4gICAgJyRodHRwJyxcbiAgICAnJHJvb3RTY29wZScsXG4gICAgJyRzdGF0ZScsXG4gICAgJ1Nlc3Npb24nLFxuICAgIGZ1bmN0aW9uKCRxLCAkaHR0cCwgJHJvb3RTY29wZSwgJHN0YXRlLCBTZXNzaW9uKSB7XG4gICAgICB2YXIgYXV0aFNlcnZpY2UgPSB7fTtcbiAgICAgIHZhciBiYXNlVXJsID0gJ2F1dGgvJztcblxuICAgICAgZnVuY3Rpb24gbG9naW5TdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgIHZhciBkYXRhID0gcmVzcG9uc2UuZGF0YTtcbiAgICAgICAgY29uc29sZS5sb2coJ2F1dGggc3VjY2VzcycsIGRhdGEpO1xuICAgICAgICBTZXNzaW9uLmNyZWF0ZShkYXRhLnRva2VuLCBkYXRhLnVzZXIpO1xuICAgICAgICByZXR1cm4gJHEoZnVuY3Rpb24ocmVzb2x2ZSkge1xuICAgICAgICAgIHJlc29sdmUoZGF0YS51c2VyKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIGxvZ2luRmFpbHVyZShkYXRhLCBjYWxsYmFjaykge1xuICAgICAgICBjb25zb2xlLmxvZygnYXV0aCBmYWlsJywgZGF0YSk7XG4gICAgICAgICRzdGF0ZS5nbygnbG9naW4nKTtcbiAgICAgICAgcmV0dXJuICRxKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgIHJlamVjdChkYXRhKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIH1cblxuICAgICAgYXV0aFNlcnZpY2UubG9naW5XaXRoUGFzc3dvcmQgPSBmdW5jdGlvbihlbWFpbCwgcGFzc3dvcmQpIHtcbiAgICAgICAgcmV0dXJuICRodHRwXG4gICAgICAgICAgLnBvc3QoYmFzZVVybCArICdsb2dpbicsIHtcbiAgICAgICAgICAgIGVtYWlsOiBlbWFpbCxcbiAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCxcbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKGxvZ2luU3VjY2VzcywgbG9naW5GYWlsdXJlKTtcbiAgICAgIH07XG5cbiAgICAgIC8vIFRPRE8gdW5zdXJlIGlmIHRoaXMgd29ya3MhXG4gICAgICBhdXRoU2VydmljZS5sb2dpbldpdGhUb2tlbiA9IGZ1bmN0aW9uKHRva2VuKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcIk5vdCBhY3R1YWxseSBzdXJlIGlmIHRoaXMgd29ya3MgeWV0IVwiKTtcbiAgICAgICAgcmV0dXJuICRodHRwXG4gICAgICAgICAgLnBvc3QoYmFzZVVybCArICdsb2dpbicsIHtcbiAgICAgICAgICAgIHRva2VuOiB0b2tlblxuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4obG9naW5TdWNjZXNzLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IDQwMCkge1xuICAgICAgICAgICAgICBTZXNzaW9uLmRlc3Ryb3koKS50aGVuKGxvZ2luRmFpbHVyZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gYXV0aFNlcnZpY2U7XG4gICAgfVxuICBdKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLmZhY3RvcnkoJ0dyb3VwU2VydmljZScsIFtcbiAgICAnJHEnLFxuICAgICckaHR0cCcsXG4gICAgJ1Nlc3Npb24nLFxuICAgIGZ1bmN0aW9uKCRxLCAkaHR0cCwgU2Vzc2lvbikge1xuICAgICAgdmFyIGdyb3VwcyA9ICdhcGkvZ3JvdXBzLyc7XG5cbiAgICAgIHZhciBHcm91cFNlcnZpY2UgPSB7fTtcblxuICAgICAgR3JvdXBTZXJ2aWNlLmdldEdyb3VwcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KGdyb3Vwcyk7XG4gICAgICB9O1xuXG4gICAgICBHcm91cFNlcnZpY2UuY3JlYXRlR3JvdXAgPSBmdW5jdGlvbihncm91cE5hbWUpIHtcbiAgICAgICAgcmV0dXJuICRodHRwLnBvc3QoZ3JvdXBzLCB7IGdyb3VwTmFtZTogZ3JvdXBOYW1lIH0pO1xuICAgICAgfTtcblxuICAgICAgR3JvdXBTZXJ2aWNlLmdldFZvbHVudGVlcnMgPSBmdW5jdGlvbihncm91cElkKSB7XG4gICAgICAgIHJldHVybiAkaHR0cC5nZXQoZ3JvdXBzICsgZ3JvdXBJZCArICcvdm9sdW50ZWVycycpO1xuICAgICAgfTtcblxuICAgICAgR3JvdXBTZXJ2aWNlLmFkZFZvbHVudGVlclRvR3JvdXAgPSBmdW5jdGlvbih2b2x1bnRlZXJJZCwgZ3JvdXBJZCkge1xuICAgICAgICByZXR1cm4gJGh0dHAucHV0KGdyb3VwcyArIGdyb3VwSWQgKyAnL3ZvbHVudGVlcnMvJyArIHZvbHVudGVlcklkKTtcbiAgICAgIH07XG5cbiAgICAgIEdyb3VwU2VydmljZS5yZW1vdmVWb2x1bnRlZXJGcm9tR3JvdXAgPSBmdW5jdGlvbih2b2x1bnRlZXJJZCwgZ3JvdXBJZCkge1xuICAgICAgICByZXR1cm4gJGh0dHAuZGVsZXRlKGdyb3VwcyArIGdyb3VwSWQgKyAnL3ZvbHVudGVlcnMvJyArIHZvbHVudGVlcklkKTtcbiAgICAgIH07XG5cbiAgICAgIEdyb3VwU2VydmljZS5hZGRVc2Vyc1RvR3JvdXAgPSBmdW5jdGlvbihncm91cElkLCB1c2VySWRzKSB7XG4gICAgICAgIHJldHVybiAkaHR0cC5wdXQoZ3JvdXBzICsgZ3JvdXBJZCArICcvdXNlcnMnLCB7IHVzZXJzOiB1c2VySWRzIH0pO1xuICAgICAgfTtcblxuICAgICAgR3JvdXBTZXJ2aWNlLnJlbW92ZVVzZXJzRnJvbUdyb3VwID0gZnVuY3Rpb24oZ3JvdXBJZCwgdXNlcklkcykge1xuICAgICAgICByZXR1cm4gJGh0dHAuZGVsZXRlKGdyb3VwcyArIGdyb3VwSWQgKyAnL3VzZXJzJywgeyB1c2VyczogdXNlcklkcyB9KTtcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBHcm91cFNlcnZpY2U7XG4gICAgfVxuICBdKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLnNlcnZpY2UoJ1Nlc3Npb24nLCBbXG4gICAgJyRyb290U2NvcGUnLFxuICAgICckd2luZG93JyxcbiAgICAnJHEnLFxuICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICR3aW5kb3csICRxKXtcbiAgICAgIHRoaXMuY3JlYXRlID0gZnVuY3Rpb24odG9rZW4sIHVzZXIpe1xuICAgICAgICAkd2luZG93LmxvY2FsU3RvcmFnZS5qd3QgPSB0b2tlbjtcbiAgICAgICAgJHdpbmRvdy5sb2NhbFN0b3JhZ2UudXNlcklkID0gdXNlci5faWQ7XG4gICAgICAgICR3aW5kb3cubG9jYWxTdG9yYWdlLmN1cnJlbnRVc2VyID0gSlNPTi5zdHJpbmdpZnkodXNlcik7XG4gICAgICAgICRyb290U2NvcGUuY3VycmVudFVzZXIgPSB1c2VyO1xuICAgICAgfTtcblxuICAgICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgZGVsZXRlICR3aW5kb3cubG9jYWxTdG9yYWdlLmp3dDtcbiAgICAgICAgZGVsZXRlICR3aW5kb3cubG9jYWxTdG9yYWdlLnVzZXJJZDtcbiAgICAgICAgZGVsZXRlICR3aW5kb3cubG9jYWxTdG9yYWdlLmN1cnJlbnRVc2VyO1xuICAgICAgICAkcm9vdFNjb3BlLmN1cnJlbnRVc2VyID0gbnVsbDtcbiAgICAgICAgcmV0dXJuICRxKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICB0aGlzLmdldFRva2VuID0gZnVuY3Rpb24oKXtcbiAgICAgICAgcmV0dXJuICR3aW5kb3cubG9jYWxTdG9yYWdlLmp3dDtcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuZ2V0VXNlcklkID0gZnVuY3Rpb24oKXtcbiAgICAgICAgcmV0dXJuICR3aW5kb3cubG9jYWxTdG9yYWdlLnVzZXJJZDtcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuZ2V0VXNlciA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKCR3aW5kb3cubG9jYWxTdG9yYWdlLmN1cnJlbnRVc2VyKTtcbiAgICAgIH07XG4gIH1dKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLmZhY3RvcnkoJ1VzZXJTZXJ2aWNlJywgW1xuICAgICckcScsXG4gICAgJyRodHRwJyxcbiAgICAnU2Vzc2lvbicsXG4gICAgZnVuY3Rpb24oJHEsICRodHRwLCBTZXNzaW9uKSB7XG4gICAgICB2YXIgdXNlcnMgPSAnYXBpL3VzZXJzJztcbiAgICAgIHZhciBiYXNlID0gdXNlcnMgKyAnLyc7XG5cbiAgICAgIHZhciBVc2VyU2VydmljZSA9IHt9O1xuXG4gICAgICBVc2VyU2VydmljZS5nZXRVc2VycyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMucGFnZSAhPT0gdW5kZWZpbmVkIHx8IG9wdGlvbnMuc2l6ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgb3B0aW9ucy5wYWdlID0gb3B0aW9ucy5wYWdlIHx8IDA7XG4gICAgICAgICAgb3B0aW9ucy5zaXplID0gb3B0aW9ucy5zaXplIHx8IDUwO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETyBbYWRhaV0geWVzIHRoaXMgaXMga2luZGEgZHVtYiBhbmQgc2hvdWxkIGJlIGJldHRlclxuICAgICAgICB2YXIgdXJsID0gb3B0aW9ucyA/IHVzZXJzICsgJz8nICsgJC5wYXJhbShcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiBvcHRpb25zLnRleHQsXG4gICAgICAgICAgICBwYWdlOiBvcHRpb25zLnBhZ2UsXG4gICAgICAgICAgICBzaXplOiBvcHRpb25zLnNpemUsXG4gICAgICAgICAgICBncm91cDogb3B0aW9ucy5ncm91cElkLFxuICAgICAgICAgIH0pIDogYmFzZTtcblxuICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCk7XG4gICAgICB9O1xuXG4gICAgICBVc2VyU2VydmljZS5jaGVja2luID0gZnVuY3Rpb24odXNlcklkKSB7XG4gICAgICAgIHJldHVybiAkaHR0cC5wb3N0KGJhc2UgKyB1c2VySWQgKyAnL2NoZWNraW4nKTtcbiAgICAgIH07XG5cbiAgICAgIFVzZXJTZXJ2aWNlLmNoZWNrb3V0ID0gZnVuY3Rpb24odXNlcklkKSB7XG4gICAgICAgIHJldHVybiAkaHR0cC5wb3N0KGJhc2UgKyB1c2VySWQgKyAnL2NoZWNrb3V0Jyk7XG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gVXNlclNlcnZpY2U7XG4gICAgfVxuICBdKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLmNvbnRyb2xsZXIoJ0NoZWNraW5Db250cm9sbGVyJywgW1xuICAgICckc2NvcGUnLFxuICAgICdVc2VyU2VydmljZScsXG4gICAgZnVuY3Rpb24oJHNjb3BlLCBVc2VyU2VydmljZSkge1xuICAgICAgLy8gVE9ETyBtYWtlIHRoaXMgYSBkaXJlY3RpdmVcbiAgICAgIHZhciAkc2VhcmNoID0gJCgnLnVzZXJTZWFyY2ggPiAuc3RpY2t5Jyk7XG4gICAgICAkc2VhcmNoLnN0aWNreSh7XG4gICAgICAgIGNvbnRleHQ6ICcudXNlckxpc3QgPiB0YWJsZScsXG4gICAgICB9KTtcblxuICAgICAgdmFyIGN1cnJlbnRRdWVyeSA9IG51bGw7XG4gICAgICAvLyBvbmx5IHJldHVybiBuZXcgcXVlcnkgaWYgbGVuZ3RoID49IDMsIGVsc2UgcmV0dXJuXG4gICAgICBmdW5jdGlvbiBnZXRRdWVyeSgpIHtcbiAgICAgICAgaWYgKCEkc2NvcGUucXVlcnkpIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSBlbHNlIGlmICgkc2NvcGUucXVlcnkubGVuZ3RoID4gMCAmJiAkc2NvcGUucXVlcnkubGVuZ3RoIDwgMykge1xuICAgICAgICAgIHJldHVybiBjdXJyZW50UXVlcnk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICRzY29wZS5xdWVyeTtcbiAgICAgIH1cblxuICAgICAgJHNjb3BlLnNlYXJjaFVzZXJzID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBxdWVyeSA9IGdldFF1ZXJ5KCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwicXVlcnk6XCIsIHF1ZXJ5KTtcblxuICAgICAgICBpZiAocXVlcnkgPT09IGN1cnJlbnRRdWVyeSkgeyByZXR1cm47IH1cbiAgICAgICAgY3VycmVudFF1ZXJ5ID0gcXVlcnk7XG4gICAgICAgIFxuICAgICAgICAvLyB0aGlzIGlzIGFsbCBhIGxvdy1rZXkgd29ya2Fyb3VuZCBmb3IgJGh0dHAncyBsYWNrIG9mIGNhbmNlbCgpXG4gICAgICAgIFVzZXJTZXJ2aWNlLmdldFVzZXJzKHtcbiAgICAgICAgICBwYWdlOiAwLCAvLyBpbmRpY2F0ZSB0aGF0IHdlIHdhbnQgdGhpcyB0byBiZSBwYWdlZCAoc2l6ZSBpcyBkZWZhdWx0IDUwKVxuICAgICAgICAgIHRleHQ6IHF1ZXJ5LFxuICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgLy8gaWYgdGhpcyBpcyBubyBsb25nZXIgdGhlIG1vc3QgcmVjZW50IHF1ZXJ5LCB0aGVuIGlnbm9yZVxuICAgICAgICAgIGlmIChxdWVyeSAhPT0gY3VycmVudFF1ZXJ5KSB7IHJldHVybjsgfVxuICAgICAgICAgIHJlc2V0VXNlckxpc3QoKTtcbiAgICAgICAgICBsb2FkRnJvbVJlc3BvbnNlLmJpbmQoJHNjb3BlLnVzZXJzKShyZXNwb25zZSk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgJHNjb3BlLnVzZXJzID0ge307XG4gICAgICBmdW5jdGlvbiByZXNldFVzZXJMaXN0KCkge1xuICAgICAgICAkc2NvcGUudXNlcnMgPSB7XG4gICAgICAgICAgdXNlcnM6IFtdLFxuICAgICAgICAgIGJ1c3k6IGZhbHNlLFxuICAgICAgICAgIG5leHRQYWdlOiAwLFxuICAgICAgICAgIHRvdGFsUGFnZXM6IDAsXG4gICAgICAgICAgdG90YWxVc2VyczogMCxcbiAgICAgICAgICBnZXROZXh0UGFnZTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5idXN5KSB7IHJldHVybjsgfVxuXG4gICAgICAgICAgICB0aGlzLmJ1c3kgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5uZXh0UGFnZSA9IHRoaXMubmV4dFBhZ2UgKyAxO1xuXG4gICAgICAgICAgICBVc2VyU2VydmljZS5nZXRVc2Vycyh7XG4gICAgICAgICAgICAgIHRleHQ6IGdldFF1ZXJ5KCksXG4gICAgICAgICAgICAgIHBhZ2U6IHRoaXMubmV4dFBhZ2UsXG4gICAgICAgICAgICB9KS50aGVuKGxvYWRGcm9tUmVzcG9uc2UuYmluZCh0aGlzKSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIHJlc2V0VXNlckxpc3QoKTtcblxuICAgICAgJHNjb3BlLnNlbGVjdGVkVXNlciA9IG51bGw7XG4gICAgICAkc2NvcGUuc2V0U2VsZWN0ZWRVc2VyID0gZnVuY3Rpb24odXNlcikge1xuICAgICAgICB2YXIgJHVzZXJEZXRhaWxzID0gJCgnLnVzZXJEZXRhaWxzJyk7XG4gICAgICAgICR1c2VyRGV0YWlscy5tb2RhbCgpO1xuICAgICAgICAkc2NvcGUuc2VsZWN0ZWRVc2VyID0gdXNlcjtcbiAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAkdXNlckRldGFpbHMubW9kYWwoJ3Nob3cnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAkdXNlckRldGFpbHMubW9kYWwoJ2hpZGUnKTtcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgJHNjb3BlLnVzZXJzLmdldE5leHRQYWdlKCk7XG5cbiAgICAgIGZ1bmN0aW9uIGxvYWRGcm9tUmVzcG9uc2UocmVzcG9uc2UpIHtcbiAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7XG5cbiAgICAgICAgdGhpcy51c2VycyA9IHRoaXMudXNlcnMuY29uY2F0KHJlc3BvbnNlLmRhdGEudXNlcnMpO1xuXG4gICAgICAgIHRoaXMudG90YWxVc2VycyA9IHJlc3BvbnNlLmRhdGEudG90YWxVc2VycztcbiAgICAgICAgdGhpcy50b3RhbFBhZ2VzID0gcmVzcG9uc2UuZGF0YS50b3RhbFBhZ2VzO1xuICAgICAgICB0aGlzLm5leHRQYWdlID0gdGhpcy5uZXh0UGFnZSArIDE7XG4gICAgICAgIHRoaXMuYnVzeSA9IGZhbHNlO1xuXG4gICAgICAgICRzZWFyY2guc3RpY2t5KCdyZWZyZXNoJyk7XG4gICAgICB9XG5cbiAgICAgICRzY29wZS5jaGVja2luID0gZnVuY3Rpb24odXNlcklkKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdjaGVja2luJywgdXNlcklkKTtcbiAgICAgICAgLy8gVXNlclNlcnZpY2UuY2hlY2tpbih1c2VySWQpXG4gICAgICAgIC8vICAgLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAvLyAgICAgY29uc29sZS5sb2coJ2NoZWNrZWQgaW4nLCBkYXRhKTtcbiAgICAgICAgLy8gICB9KTtcbiAgICAgIH07XG5cbiAgICAgICRzY29wZS5jaGVja291dCA9IGZ1bmN0aW9uKHVzZXJJZCkge1xuICAgICAgICBjb25zb2xlLmxvZygnY2hlY2tvdXQnLCB1c2VySWQpO1xuICAgICAgICAvLyBVc2VyU2VydmljZS5jaGVja291dCh1c2VySWQpXG4gICAgICAgIC8vICAgLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAvLyAgICAgY29uc29sZS5sb2coJ2NoZWNrZWQgb3V0JywgZGF0YSk7XG4gICAgICAgIC8vICAgfSk7XG4gICAgICB9O1xuICAgIH1cbiAgXSk7XG4iLCJhbmd1bGFyLm1vZHVsZSgnY2hlY2tpbicpXG4gIC5jb250cm9sbGVyKCdHcm91cHNDb250cm9sbGVyJywgW1xuICAgICckc2NvcGUnLFxuICAgICdVc2VyU2VydmljZScsXG4gICAgJ0dyb3VwU2VydmljZScsXG4gICAgZnVuY3Rpb24gKCRzY29wZSwgVXNlclNlcnZpY2UsIEdyb3VwU2VydmljZSkge1xuICAgICAgJHNjb3BlLmdyb3VwcyA9IFtdO1xuXG4gICAgICAkc2NvcGUuZ2V0R3JvdXBzID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIEdyb3VwU2VydmljZS5nZXRHcm91cHMoKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgJHNjb3BlLmdyb3VwcyA9IHJlc3BvbnNlLmRhdGE7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgICRzY29wZS5nZXRHcm91cHMoKTtcblxuICAgICAgJHNjb3BlLmNyZWF0ZUdyb3VwID0gZnVuY3Rpb24oZ3JvdXBOYW1lKSB7XG4gICAgICAgIGlmICghZ3JvdXBOYW1lKSB7IHJldHVybjsgfVxuXG4gICAgICAgIEdyb3VwU2VydmljZS5jcmVhdGVHcm91cChncm91cE5hbWUpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAkc2NvcGUuZ3JvdXBzLnB1c2gocmVzcG9uc2UuZGF0YSk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgJHNjb3BlLnNlbGVjdGVkR3JvdXAgPSBudWxsO1xuICAgICAgJHNjb3BlLnNlbGVjdEdyb3VwID0gZnVuY3Rpb24oZ3JvdXApIHtcbiAgICAgICAgJHNjb3BlLnNlbGVjdGVkTmV3Vm9sdW50ZWVyID0gbnVsbDtcbiAgICAgICAgJHNjb3BlLnNlbGVjdGVkR3JvdXAgPSBncm91cDtcbiAgICAgICAgR3JvdXBTZXJ2aWNlLmdldFZvbHVudGVlcnMoZ3JvdXAuX2lkKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgJHNjb3BlLnNlbGVjdGVkR3JvdXAudm9sdW50ZWVycyA9IHJlc3BvbnNlLmRhdGEudm9sdW50ZWVycztcbiAgICAgICAgfSk7XG4gICAgICAgIFVzZXJTZXJ2aWNlLmdldFVzZXJzKHsgZ3JvdXBJZDogZ3JvdXAuX2lkIH0pLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAkc2NvcGUuc2VsZWN0ZWRHcm91cC51c2VycyA9IHJlc3BvbnNlLmRhdGEudXNlcnM7XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgJHNjb3BlLnNlbGVjdGVkTmV3Vm9sdW50ZWVyID0gbnVsbDtcbiAgICAgICRzY29wZS5zZXRTZWxlY3RlZE5ld1ZvbHVudGVlciA9IGZ1bmN0aW9uKHVzZXIpIHtcbiAgICAgICAgJHNjb3BlLnNlbGVjdGVkTmV3Vm9sdW50ZWVyID0gdXNlcjtcbiAgICAgICAgLy8gZm9yY2UgdWkgcmVmcmVzaCAob3RoZXJ3aXNlIHdhaXQgdW50aWwgYW5vdGhlciBldmVudCBmaXJlcylcbiAgICAgICAgLy8gb25seSB3aGVuIHRoaXMgaXMgaW5pdGlhdGVkIGJ5IHRoZSBzZWFyY2hcbiAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAkc2NvcGUuJGFwcGx5KCk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgICRzY29wZS5hZGROZXdWb2x1bnRlZXIgPSBmdW5jdGlvbih1c2VyLCBncm91cCkge1xuICAgICAgICBHcm91cFNlcnZpY2UuYWRkVm9sdW50ZWVyVG9Hcm91cCh1c2VyLl9pZCwgZ3JvdXAuX2lkKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAkc2NvcGUuc2VsZWN0ZWRHcm91cC52b2x1bnRlZXJzLnB1c2gocmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgICAkc2NvcGUuc2V0U2VsZWN0ZWROZXdWb2x1bnRlZXIobnVsbCk7XG4gICAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICAkc2NvcGUucmVtb3ZlVm9sdW50ZWVyRnJvbUdyb3VwID0gZnVuY3Rpb24odXNlciwgZ3JvdXApIHtcbiAgICAgICAgR3JvdXBTZXJ2aWNlLnJlbW92ZVZvbHVudGVlckZyb21Hcm91cCh1c2VyLl9pZCwgZ3JvdXAuX2lkKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAkc2NvcGUuc2VsZWN0ZWRHcm91cC52b2x1bnRlZXJzLnNwbGljZShcbiAgICAgICAgICAgICAgJHNjb3BlLnNlbGVjdGVkR3JvdXAudm9sdW50ZWVycy5maW5kSW5kZXgoZnVuY3Rpb24oZWxlbSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLl9pZCA9PT0gcmVzcG9uc2UuZGF0YS5faWQ7XG4gICAgICAgICAgICAgIH0pLCAxKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH07XG5cbiAgICAgIC8vIFRPRE8gbW92ZSB0aGlzIHRvIGEgZGlyZWN0aXZlP1xuICAgICAgJCgnLmFkZC12b2x1bnRlZXInKS5zZWFyY2goe1xuICAgICAgICBhcGlTZXR0aW5nczoge1xuICAgICAgICAgIHJlc3BvbnNlQXN5bmM6IGZ1bmN0aW9uKHNldHRpbmdzLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gc2V0dGluZ3MudXJsRGF0YS5xdWVyeTtcbiAgICAgICAgICAgIFVzZXJTZXJ2aWNlLmdldFVzZXJzKHt0ZXh0OiBzZXR0aW5ncy51cmxEYXRhLnF1ZXJ5fSlcbiAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oc2VydmVyUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICByZXN1bHRzID0gc2VydmVyUmVzcG9uc2UuZGF0YS51c2Vyc1xuICAgICAgICAgICAgICAgICAgLy8gZmlsdGVyIG91dCB2b2x1bnRlZXJzIHRoYXQgYXJlIGFscmVhZHkgc2VsZWN0ZWRcbiAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24odXNlcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLnNlbGVjdGVkR3JvdXAudm9sdW50ZWVycy5maW5kSW5kZXgoZnVuY3Rpb24odm9sdW50ZWVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZvbHVudGVlci5faWQgPT09IHVzZXIuX2lkO1xuICAgICAgICAgICAgICAgICAgICB9KSA9PT0gLTE7XG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgLy8gbWFwIHNlcnZlciByZXNwb25zZSB0byBtYXRjaCB1aSBzZWFyY2gncyBleHBlY3RlZCBmb3JtYXRcbiAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odXNlcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiB1c2VyLnByb2ZpbGUubmFtZSB8fCB1c2VyLmVtYWlsLFxuICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB1c2VyLnByb2ZpbGUubmFtZSA/IHVzZXIuZW1haWwgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgdXNlcjogdXNlcixcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdHMsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG1pbkNoYXJhY3RlcnMgOiAzLFxuICAgICAgICBvblNlbGVjdDogZnVuY3Rpb24oc2VsZWN0aW9uKSB7XG4gICAgICAgICAgJHNjb3BlLnNldFNlbGVjdGVkTmV3Vm9sdW50ZWVyKHNlbGVjdGlvbi51c2VyKTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBUT0RPIHRoaXMgbmVlZHMgdG8gYmUgaW4gYSBkaXJlY3RpdmVcbiAgICAgIC8vIChzZWUgYWxtb3N0IGV4YWN0IGNvcHkgb2YgdGhpcyBjb2RlIGluIENoZWNraW5Db250cm9sbGVyKVxuICAgICAgdmFyIGN1cnJlbnRRdWVyeSA9IG51bGw7XG4gICAgICAkc2NvcGUuc2VhcmNoVXNlcnMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHF1ZXJ5ID0gZ2V0UXVlcnkoKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJxdWVyeTpcIiwgcXVlcnkpO1xuXG4gICAgICAgIGlmICghcXVlcnkgfHwgcXVlcnkgPT09IGN1cnJlbnRRdWVyeSkgeyByZXR1cm47IH1cbiAgICAgICAgY3VycmVudFF1ZXJ5ID0gcXVlcnk7XG5cbiAgICAgICAgVXNlclNlcnZpY2UuZ2V0VXNlcnMoe1xuICAgICAgICAgIHRleHQ6IHF1ZXJ5LFxuICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgaWYgKHF1ZXJ5ICE9PSBjdXJyZW50UXVlcnkpIHsgcmV0dXJuOyB9XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7XG5cbiAgICAgICAgICBzZXRTZWFyY2hVc2VycyhyZXNwb25zZS5kYXRhLnVzZXJzKTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICBmdW5jdGlvbiBzZXRTZWFyY2hVc2VycyAoc2VhcmNoUmVzdWx0cykge1xuICAgICAgICBzZWFyY2hSZXN1bHRzID0gc2VhcmNoUmVzdWx0cyB8fCAkc2NvcGUuc2VsZWN0ZWRHcm91cC5zZWFyY2hVc2VycztcbiAgICAgICAgJHNjb3BlLnNlbGVjdGVkR3JvdXAuc2VhcmNoVXNlcnMgPSBzZWFyY2hSZXN1bHRzXG4gICAgICAgICAgLy8gZmlsdGVyIG91dCBhbnkgdXNlcnMgdGhhdCBhcmUgYWxyZWFkeSBpbiB0aGlzIGdyb3VwXG4gICAgICAgICAgLmZpbHRlcihmdW5jdGlvbih1c2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gJHNjb3BlLnNlbGVjdGVkR3JvdXAudXNlcnMuZmluZEluZGV4KGZ1bmN0aW9uKGdyb3VwVXNlcikge1xuICAgICAgICAgICAgICByZXR1cm4gZ3JvdXBVc2VyLl9pZCA9PT0gdXNlci5faWQ7XG4gICAgICAgICAgICB9KSA9PT0gLTE7XG4gICAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIGdldFF1ZXJ5KCkge1xuICAgICAgICBpZiAoISRzY29wZS51c2VyUXVlcnkgfHwgJHNjb3BlLnVzZXJRdWVyeS5sZW5ndGggPCAzKSB7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICRzY29wZS51c2VyUXVlcnk7XG4gICAgICB9XG5cbiAgICAgICRzY29wZS5hZGRVc2Vyc1RvR3JvdXAgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHNlbGVjdGVkVXNlcnMgPSAkc2NvcGUuc2VsZWN0ZWRHcm91cC5zZWFyY2hVc2Vycy5maWx0ZXIoZnVuY3Rpb24odXNlcikge1xuICAgICAgICAgIHJldHVybiB1c2VyLmFjdGl2ZTtcbiAgICAgICAgfSkubWFwKGZ1bmN0aW9uKHVzZXIpIHtcbiAgICAgICAgICByZXR1cm4gdXNlci5faWQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIEdyb3VwU2VydmljZS5hZGRVc2Vyc1RvR3JvdXAoJHNjb3BlLnNlbGVjdGVkR3JvdXAuX2lkLCBzZWxlY3RlZFVzZXJzKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAkc2NvcGUuc2VsZWN0ZWRHcm91cC51c2VycyA9IHJlc3BvbnNlLmRhdGEudXNlcnM7XG4gICAgICAgICAgICBzZXRTZWFyY2hVc2VycygpO1xuICAgICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgJHNjb3BlLmFkZEFsbFVzZXJzVG9Hcm91cCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZWN0ZWRVc2VycyA9ICRzY29wZS5zZWxlY3RlZEdyb3VwLnNlYXJjaFVzZXJzLm1hcChmdW5jdGlvbih1c2VyKSB7XG4gICAgICAgICAgcmV0dXJuIHVzZXIuX2lkO1xuICAgICAgICB9KTtcblxuICAgICAgICBHcm91cFNlcnZpY2UuYWRkVXNlcnNUb0dyb3VwKCRzY29wZS5zZWxlY3RlZEdyb3VwLl9pZCwgc2VsZWN0ZWRVc2VycylcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgJHNjb3BlLnNlbGVjdGVkR3JvdXAudXNlcnMgPSByZXNwb25zZS5kYXRhLnVzZXJzO1xuICAgICAgICAgICAgc2V0U2VhcmNoVXNlcnMoKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgfVxuICBdKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGVja2luJylcbiAgLmNvbnRyb2xsZXIoJ0xvZ2luQ29udHJvbGxlcicsIFtcbiAgICAnJHNjb3BlJyxcbiAgICAnJHN0YXRlJyxcbiAgICAnQXV0aFNlcnZpY2UnLFxuICAgIGZ1bmN0aW9uKCRzY29wZSwgJHN0YXRlLCBBdXRoU2VydmljZSkge1xuXG4gICAgICBmdW5jdGlvbiBvblN1Y2Nlc3MoZGF0YSkge1xuICAgICAgICBjb25zb2xlLmxvZygnc3VjY2VzcycsIGRhdGEpO1xuICAgICAgICAkc3RhdGUuZ28oJ2FwcC5jaGVja2luJyk7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIG9uRmFpbHVyZShkYXRhKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdmYWlsdXJlJywgZGF0YSk7XG4gICAgICB9XG5cbiAgICAgICRzY29wZS5sb2dpbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBBdXRoU2VydmljZS5sb2dpbldpdGhQYXNzd29yZChcbiAgICAgICAgICAkc2NvcGUuZW1haWwsICRzY29wZS5wYXNzd29yZFxuICAgICAgICApLnRoZW4ob25TdWNjZXNzLCBvbkZhaWx1cmUpO1xuICAgICAgfTtcbiAgICB9XG4gIF0pO1xuIiwiYW5ndWxhci5tb2R1bGUoJ2NoZWNraW4nKVxuICAuY29udHJvbGxlcignVG9vbGJhckNvbnRyb2xsZXInLCBbXG4gICAgJyRzY29wZScsXG4gICAgJyRzdGF0ZScsXG4gICAgJyRyb290U2NvcGUnLFxuICAgICdTZXNzaW9uJyxcbiAgICBmdW5jdGlvbigkc2NvcGUsICRzdGF0ZSwgJHJvb3RTY29wZSwgU2Vzc2lvbikge1xuICAgICAgdmFyIHVzZXIgPSBTZXNzaW9uLmdldFVzZXIoKTtcblxuICAgICAgJHNjb3BlLnN0YXRlcyA9IChbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiAnYXBwLmNoZWNraW4nLFxuICAgICAgICAgIHRpdGxlOiAnQ2hlY2tpbicsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiAnYXBwLmdyb3VwcycsXG4gICAgICAgICAgdGl0bGU6ICdHcm91cHMnLFxuICAgICAgICAgIGFkbWluT25seTogdHJ1ZSxcbiAgICAgICAgfVxuICAgICAgXSkuZmlsdGVyKGZ1bmN0aW9uKHN0YXRlKSB7XG4gICAgICAgIHJldHVybiAhKHN0YXRlLmFkbWluT25seSAmJiAhdXNlci5hZG1pbik7XG4gICAgICB9KTtcblxuICAgICAgJCgnLmxvZ291dCcpLmNsaWNrKGZ1bmN0aW9uKCkge1xuICAgICAgICBTZXNzaW9uLmRlc3Ryb3koKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICRzdGF0ZS5nbygnbG9naW4nKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIF0pO1xuIiwiLyoqXG4gKiBIZXJlIGxheSB0aGUgYmFzZSB1cmxzIHVzZWQgaW4gdGhlIGh0dHAgdXJsIGluamVjdG9yXG4gKi9cbmFuZ3VsYXIubW9kdWxlKCdjaGVja2luJykuY29uc3RhbnQoJ1NFUlZFUl9VUkwnLCB7XG4gIEJBU0VfVVJMOiAgJ2h0dHBzOi8vY2U0ZTc1NzEubmdyb2suaW8vJyxcbiAgLy8gQkFTRV9VUkw6ICAnaHR0cHM6Ly9hcHBseS5oYWNrZ3QuY29tLycsXG5cbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
